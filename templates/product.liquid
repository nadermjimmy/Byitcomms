{% comment %}
  Product Template - Individual Property Page
{% endcomment %}

<div class="product-page" data-section-id="product-{{ product.id }}" data-section-type="product">
  <div class="page-width">
    
    {% comment %} Breadcrumb Navigation {% endcomment %}
    <nav class="breadcrumb" role="navigation" aria-label="breadcrumbs">
      <a href="{{ routes.root_url }}" class="breadcrumb__link">{{ 'general.breadcrumbs.home' | t }}</a>
      <span class="breadcrumb__separator">
        <svg width="6" height="10" viewBox="0 0 6 10" fill="none">
          <path d="M1 1L5 5L1 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </span>
      {% if collection %}
        <a href="{{ collection.url }}" class="breadcrumb__link">{{ collection.title }}</a>
        <span class="breadcrumb__separator">
          <svg width="6" height="10" viewBox="0 0 6 10" fill="none">
            <path d="M1 1L5 5L1 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
      {% endif %}
      <span class="breadcrumb__text">{{ product.title }}</span>
    </nav>

    <div class="product-main">
      
      {% comment %} Product Gallery {% endcomment %}
      <div class="product-gallery" data-product-gallery>
        <div class="product-gallery__main">
          {% if product.media.size > 0 %}
            <div class="product-gallery__featured" data-gallery-featured>
              {% for media in product.media limit: 1 %}
                {% if media.media_type == 'image' %}
                  <img
                    src="{{ media | image_url: width: 800 }}"
                    alt="{{ media.alt | escape }}"
                    srcset="
                      {{ media | image_url: width: 400 }} 400w,
                      {{ media | image_url: width: 600 }} 600w,
                      {{ media | image_url: width: 800 }} 800w,
                      {{ media | image_url: width: 1000 }} 1000w
                    "
                    sizes="(min-width: 990px) 60vw, 90vw"
                    loading="eager"
                    class="product-gallery__image"
                    data-gallery-main-image
                  >
                {% endif %}
              {% endfor %}
            </div>
            
            {% if product.media.size > 1 %}
              <div class="product-gallery__thumbnails" data-gallery-thumbnails>
                {% for media in product.media %}
                  {% if media.media_type == 'image' %}
                    <button type="button" class="product-gallery__thumbnail{% if forloop.first %} product-gallery__thumbnail--active{% endif %}" data-gallery-thumbnail data-media-id="{{ media.id }}">
                      <img
                        src="{{ media | image_url: width: 150 }}"
                        alt="{{ media.alt | escape }}"
                        loading="lazy"
                        class="product-gallery__thumbnail-image"
                      >
                    </button>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          {% else %}
            <div class="product-gallery__placeholder">
              <svg width="80" height="80" viewBox="0 0 80 80" fill="none">
                <path d="M10 70h60M10 70V30l30-20 30 20v40M10 70h60M30 70V40h20v30" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          {% endif %}
        </div>

        {% comment %} Gallery Actions {% endcomment %}
        <div class="product-gallery__actions">
          <button type="button" class="product-gallery__action" data-wishlist-toggle data-product-id="{{ product.id }}">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M10 17.5s-7.5-5-7.5-10a3.75 3.75 0 0 1 7.5 0 3.75 3.75 0 0 1 7.5 0c0 5-7.5 10-7.5 10z" stroke="currentColor" stroke-width="1.5" fill="none"/>
            </svg>
            <span class="product-gallery__action-text">{{ 'products.add_to_wishlist' | t }}</span>
          </button>
          
          <button type="button" class="product-gallery__action" data-share-toggle>
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M15 6.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5zM5 11a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5zM15 18.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5zM6.59 9.41l6.82 3.59M13.41 6.59l-6.82 3.59" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="product-gallery__action-text">{{ 'products.share' | t }}</span>
          </button>
        </div>
      </div>

      {% comment %} Product Information {% endcomment %}
      <div class="product-info">
        
        {% comment %} Property Badges {% endcomment %}
        <div class="product-badges">
          {% if product.available %}
            <span class="product-badge product-badge--available">{{ 'products.available' | t }}</span>
          {% endif %}
          
          {% if product.tags contains 'featured' %}
            <span class="product-badge product-badge--featured">{{ 'products.featured' | t }}</span>
          {% endif %}
          
          {% if product.metafields.property.completion_status %}
            <span class="product-badge product-badge--{{ product.metafields.property.completion_status.value | handle }}">
              {{ product.metafields.property.completion_status.value }}
            </span>
          {% endif %}
        </div>

        {% comment %} Property Title and Location {% endcomment %}
        <header class="product-header">
          <h1 class="product-title">{{ product.title }}</h1>
          
          {% if product.metafields.property.location %}
            <div class="product-location">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 1c2.21 0 4 1.79 4 4 0 2.21-1.79 4-4 4s-4-1.79-4-4c0-2.21 1.79-4 4-4zm0 14c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/>
              </svg>
              <span class="product-location__text">{{ product.metafields.property.location.value }}</span>
            </div>
          {% endif %}
        </header>

        {% comment %} Property Details Grid {% endcomment %}
        <div class="product-details">
          {% if product.metafields.property.type %}
            <div class="product-detail">
              <span class="product-detail__label">{{ 'products.property_type' | t }}</span>
              <span class="product-detail__value">{{ product.metafields.property.type.value }}</span>
            </div>
          {% endif %}
          
          {% if product.metafields.property.bedrooms %}
            <div class="product-detail">
              <span class="product-detail__label">{{ 'products.bedrooms' | t }}</span>
              <span class="product-detail__value">{{ product.metafields.property.bedrooms.value }}</span>
            </div>
          {% endif %}
          
          {% if product.metafields.property.bathrooms %}
            <div class="product-detail">
              <span class="product-detail__label">{{ 'products.bathrooms' | t }}</span>
              <span class="product-detail__value">{{ product.metafields.property.bathrooms.value }}</span>
            </div>
          {% endif %}
          
          {% if product.metafields.property.area %}
            <div class="product-detail">
              <span class="product-detail__label">{{ 'products.area' | t }}</span>
              <span class="product-detail__value">{{ product.metafields.property.area.value }} {{ 'products.sqm' | t }}</span>
            </div>
          {% endif %}
          
          {% if product.metafields.property.developer %}
            <div class="product-detail">
              <span class="product-detail__label">{{ 'products.developer' | t }}</span>
              <span class="product-detail__value">{{ product.metafields.property.developer.value }}</span>
            </div>
          {% endif %}
          
          {% if product.metafields.property.completion_date %}
            <div class="product-detail">
              <span class="product-detail__label">{{ 'products.completion_date' | t }}</span>
              <span class="product-detail__value">{{ product.metafields.property.completion_date.value | date: "%B %Y" }}</span>
            </div>
          {% endif %}
        </div>

        {% comment %} Price and Payment {% endcomment %}
        <div class="product-pricing">
          <div class="product-price">
            {% if product.compare_at_price > product.price %}
              <span class="product-price__compare">{{ product.compare_at_price | money }}</span>
            {% endif %}
            <span class="product-price__current">{{ product.price | money }}</span>
          </div>
          
          {% if product.metafields.property.payment_plan %}
            <div class="product-payment">
              <span class="product-payment__label">{{ 'products.payment_plan' | t }}:</span>
              <span class="product-payment__value">{{ product.metafields.property.payment_plan.value }}</span>
            </div>
          {% endif %}
          
          {% if product.metafields.property.monthly_installment %}
            <div class="product-payment">
              <span class="product-payment__label">{{ 'products.monthly_payment' | t }}:</span>
              <span class="product-payment__value">{{ product.metafields.property.monthly_installment.value | money }}/{{ 'products.month' | t }}</span>
            </div>
          {% endif %}
        </div>

        {% comment %} Property Description {% endcomment %}
        {% if product.description != blank %}
          <div class="product-description">
            <h3 class="product-description__title">{{ 'products.description' | t }}</h3>
            <div class="product-description__content rte">
              {{ product.description }}
            </div>
          </div>
        {% endif %}

        {% comment %} Contact Agent CTA {% endcomment %}
        <div class="product-actions">
          <button type="button" class="btn btn--primary product-actions__contact" data-contact-agent data-product-id="{{ product.id }}">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.568 17.568 0 0 0 4.168 6.608 17.569 17.569 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.678.678 0 0 0-.58-.122L9.98 10.98a.678.678 0 0 1-.684-.122L5.734 8.266a.678.678 0 0 1-.122-.684l.549-1.405a.678.678 0 0 0-.122-.58L3.654 1.328z" fill="currentColor"/>
            </svg>
            {{ 'products.contact_agent' | t }}
          </button>
          
          <button type="button" class="btn btn--outline product-actions__schedule" data-schedule-viewing data-product-id="{{ product.id }}">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <rect x="3" y="4" width="14" height="12" rx="2" ry="2" stroke="currentColor" stroke-width="1.5"/>
              <path d="M16 2v4M4 2v4M3 10h14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            {{ 'products.schedule_viewing' | t }}
          </button>
        </div>

      </div>
    </div>

    {% comment %} Property Features and Amenities {% endcomment %}
    {% if product.metafields.property.features or product.metafields.property.amenities %}
      <div class="product-features">
        {% if product.metafields.property.features %}
          <div class="product-features__section">
            <h3 class="product-features__title">{{ 'products.features' | t }}</h3>
            <div class="product-features__grid">
              {% assign features = product.metafields.property.features.value | split: ',' %}
              {% for feature in features %}
                <div class="product-features__item">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                  </svg>
                  {{ feature | strip }}
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if product.metafields.property.amenities %}
          <div class="product-features__section">
            <h3 class="product-features__title">{{ 'products.amenities' | t }}</h3>
            <div class="product-features__grid">
              {% assign amenities = product.metafields.property.amenities.value | split: ',' %}
              {% for amenity in amenities %}
                <div class="product-features__item">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                  </svg>
                  {{ amenity | strip }}
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>
    {% endif %}

    {% comment %} Related Properties {% endcomment %}
    {% assign related_products = collection.products | where: 'id', '!=', product.id | limit: 4 %}
    {% if related_products.size > 0 %}
      <div class="product-related">
        <h3 class="product-related__title">{{ 'products.related_properties' | t }}</h3>
        <div class="product-related__grid">
          {% for related_product in related_products %}
            <div class="product-related__item">
              {% render 'property-card', property: related_product, card_style: 'related' %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

  </div>
</div>

{% comment %} Contact Agent Modal {% endcomment %}
<div class="modal" id="contactAgentModal" data-modal="contact-agent" style="display: none;">
  <div class="modal__overlay" data-modal-overlay></div>
  <div class="modal__content">
    <div class="modal__header">
      <h3 class="modal__title">{{ 'products.contact_agent' | t }}</h3>
      <button type="button" class="modal__close" data-modal-close>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
    <div class="modal__body">
      <form class="contact-form" data-contact-form>
        <div class="contact-form__field">
          <label for="contact-name" class="contact-form__label">{{ 'contact.form.name' | t }} *</label>
          <input type="text" id="contact-name" name="contact[name]" class="contact-form__input" required>
        </div>
        
        <div class="contact-form__field">
          <label for="contact-email" class="contact-form__label">{{ 'contact.form.email' | t }} *</label>
          <input type="email" id="contact-email" name="contact[email]" class="contact-form__input" required>
        </div>
        
        <div class="contact-form__field">
          <label for="contact-phone" class="contact-form__label">{{ 'contact.form.phone' | t }}</label>
          <input type="tel" id="contact-phone" name="contact[phone]" class="contact-form__input">
        </div>
        
        <div class="contact-form__field">
          <label for="contact-message" class="contact-form__label">{{ 'contact.form.message' | t }}</label>
          <textarea id="contact-message" name="contact[message]" class="contact-form__textarea" rows="4">{{ 'products.contact_message_template' | t: property_title: product.title }}</textarea>
        </div>
        
        <button type="submit" class="btn btn--primary contact-form__submit">
          {{ 'contact.form.send' | t }}
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Gallery functionality
    const thumbnails = document.querySelectorAll('[data-gallery-thumbnail]');
    const mainImage = document.querySelector('[data-gallery-main-image]');
    
    thumbnails.forEach(thumbnail => {
      thumbnail.addEventListener('click', function() {
        const mediaId = this.dataset.mediaId;
        const newImageSrc = this.querySelector('img').src.replace('_150x.', '_800x.');
        
        // Update active thumbnail
        thumbnails.forEach(t => t.classList.remove('product-gallery__thumbnail--active'));
        this.classList.add('product-gallery__thumbnail--active');
        
        // Update main image
        if (mainImage) {
          mainImage.src = newImageSrc;
        }
      });
    });

    // Modal functionality
    const contactButtons = document.querySelectorAll('[data-contact-agent]');
    const modal = document.getElementById('contactAgentModal');
    const modalOverlay = modal?.querySelector('[data-modal-overlay]');
    const modalClose = modal?.querySelector('[data-modal-close]');

    contactButtons.forEach(button => {
      button.addEventListener('click', function() {
        if (modal) {
          modal.style.display = 'flex';
          document.body.style.overflow = 'hidden';
        }
      });
    });

    function closeModal() {
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }
    }

    modalOverlay?.addEventListener('click', closeModal);
    modalClose?.addEventListener('click', closeModal);

    // Escape key to close modal
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal && modal.style.display === 'flex') {
        closeModal();
      }
    });
  });
</script>